---
title: 'Linux内存寻址 (1)'
date: 2017-03-26 08:52:53 +0800
author: pathawks
version: 3.4.3
categories: [linux]
---

本文以80x86微处理器为例，探讨一下Linux是如何为程序员提供内存访问的。


### 逻辑地址转换

当使用80x86微处理器时，必须区分以下三种不同的地址：
- `逻辑地址(Logical Address)`: 每个逻辑地址都有一个段(segment)和偏移量(offset)，偏移量指明了从段起始的地方到实际地址之间的距离。
- `线性地址(Linear Address)`或也称为`虚拟地址(Virtual Address)`: 32位无符号整数来表示的高达4GB的地址。
- `物理地址(Physical Address)`: 用于内存芯片级内存单元寻址，和从CPU地址引脚发送到内存总线上的电信号相对应。物理地址由32位或36位无符号数整数表示。

`逻辑地址`到`物理地址`的转换，需要经过内存控制单元(MMU)的`分段单元`和`分页单元`的硬件电路(如下图)。


### 硬件中的分段

一个逻辑地址由两部分组成:
- `段标识符`: 长度为16bit，称为段选择符(segment selector)。其结构如下图所示。
- `段内相对地址的偏移量`: 长度为32bit。

CPU提供段寄存器用于存放段选择符，这些段寄存器有6个：`cs`(代码段寄存器)、`ss`(栈段寄存器)、`ds`(数据段寄存器)、`es`、`fs`和`gs`。`cs`寄存器还包含一个2bit的字段，用于指明CPU的当前特权级别(Current Privilege Level, CPL)，值为0代表最高优先级，值为3代表最低优先级。Linux只使用了0级和3级，分别对应内核态和用户态。

每个段由一个8字节的段描述符表示，段描述符放在全局描述符表(Global Descriptor Table, GDT)或局部描述符表(Local Descriptor Table, LDT)中。通常只定义一个GDT，而每个进程除了存放在GDT中的段之外，如果还需要创建附加的段，就可以有自己的LDT。GDT在内存中的基地址和大小存放在gdtr控制寄存器中，当前正在使用的LDT基地址和大小存放在ldtr控制寄存器中。
